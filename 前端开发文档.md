[toc]



### 撤销

目前暂定撤销只撤销笔迹，不对文字与图片等撤销。
~~将所有自己的笔迹都保存在一个栈中，撤销即pop()操作，pop()之后进行重新绘制~~

对绘制栈从上往下遍历，删除第一个自己留下的笔迹，并发送

撤销 + 笔迹hash的信息

触发重新绘制

这里需要统一所有的绘制信息
根据type分别进行绘制
统一为
{
    type: 'brush' | 'text' | 'image' | 'graph',
    data: any
}
在判断是否撤销是仅撤销bursh痕迹
其余痕迹也可考虑进行撤销，加入history字段，可以保存上次的hash值
但是这样在首次加载时需要加载很多数据，也可只加载上一个history，在撤销到上次时，再获取上次的上次
进行分段的获取。
前端的实现中对brush的数据格式以及draw方法都需要重写
将所有的绘制都集成为一个draw方法

### 重新绘制
~~绘制历史笔迹+新加入的图片+新加入的文字+新加入的笔迹~~

遍历绘制栈进行绘制

### 笔刷状态

用户笔刷状态，默认进入时是选择笔的状态
stauts= {
    1, // 选择笔的状态
    2, // 选择插入文字的状态
    3, // 选择插入图片的状态
}
在非选中笔的状态时，可以选中已经插入的文字和图片，进行位置等调整


### 插入文字功能
插入文字使用fillText(text,x,y) , 在使用前通过ctx.font(大小,字体)设置字体和大小
通过testMsg = ctx.measureText(text)获取相关信息
文字宽度 textMsg.width
文字高度 textMsg.actualBoundingBoxAscent + textMsg.actualBoundingBoxDescent
实现的方式目前考虑的是在选择插入文字之后在点击的位置插入一个透明的input的框，input失去焦点之后将input的value值返回并插入到text中
点击文字之后在他周围生成边框
拖拽之后删除原先数据并将新数据插入
决定拖拽功能以后再实现

### 插入图片功能
插入图片通过drawImage(image, x, y, height, width) 实现
iamge通过new Image();
设定iamge.src = 图片地址
预计在插入图片时，首先上传图片给后端，又后端生成图片地址，返回前端后，放在src中
需注意前端加载图片需要一小会，在onload中进行后续操作
image.onload = () => {
    ctx.drawImage(image, pointerInfo.x, pointerInfo.y, 150, 150);
}

### 笔迹数据
笔迹
{
    userId,
    userName,
    boardId,
    type: 'brush' | 'test' | 'image' | 'delect'
    data: {
        ....
    },
    hash: 笔迹hash值区分某次
}

data分情况
type = 'brush'
data = [{
    beginX: number | null,
    beginY: number | null,
    lastX: number | null,
    lastY: number | null,
    strokeStyle: string,
    lineWidth: number
}]
ps: data由很多这样的数据类型组成的一个数组

type = 'test'
data = {
    test: string,
    fontWidth: string,
    fontFamily: string,
    x: number,
    y: number,
}
ps：后续加上拖拽功能需要加上witdh和height这类字段用于定位

type = 'image'
data = {
  x: number,
  y: number,
  src: string,
  width: number,
  height: number
}


type = 'delect'

ps delect情况下不需要data，只需要对应的hash即可

新加类型

type = 'rect'
data = {
  x: number,
  y: number,
  width: number,
  height: number,
  strokeStyle?: string,
  lineWidth?: number
}

type = 'round'
data = {
  x: number,
  y: number,
  radus: number,
  strokeStyle?: string,
  lineWidth?: number
}

现在之前的基础上加上新的定位属性 并加上类型限制
用于选中时进行判断
笔迹
{
    userId: string,
    userName: string,
    boardId: string,
    type: 'brush' | 'test' | 'image' | 'delect'
    data: {
        ....
    },
    hash: string, // 笔迹hash值区分某次
    x: number, 
    y: number,
    width: number,
    height: number,
}
这里的number应该是浮点型
(x, y)用于定位笔迹的左上角
width和height计算出的矩阵为笔迹所占的矩阵

### 历史版本信息
historyList
{
    userId,
    userName,
    date,
    boardId,
    hash, 
}

这里的hash值可以与笔迹一致，标识某次操作之后的白板，有后端进行组装之后发送

### 登录功能
在进入白板时，可以选择登录或者不登陆
不做页面跳转，在一个dialog框中完成登录，输入白板id等功能
dialog起始选项为
登录按钮
白板id输入框
进入按钮

点击登录按钮，则切换为登录模式
用户账号
用户密码
忘记密码等

登录之后上述的登录按钮转换为用户头像
暂时不做注册功能

### 参照
https://github.com/wanglin2/tiny_whiteboard
https://excalidraw.com/

### 样式重写
登录时的按钮
笔刷按钮

### 选中功能
在每一个笔迹中增加一个被选中属性
当笔迹拥有被选中元素时，在绘制是在周围绘制选中框
对绘制类型加上上下左右的高度的属性
brush属性即为x和y的最小值作为左上角的起点

test 类型不加上选中框，而是将input框插入（等插入文本调整完之后再进行调整）


### 绘制矩阵、圆形
绘制矩阵分为选中时绘制边框和笔刷拉取矩阵
笔刷拉取矩阵目前考虑为点击时记录x，y然后拖动时记录每一个x，y，进行绘制，然后删除上一个，这样就可以做到拖动绘制的效果
~~目前的考虑是利用save()方法记录拉取矩阵前的状态，每一次拉取回到状态前，重复这个过程，直到松开时。~~
save只能记录画笔状态，不能记录画布的状态。
将所有的绘制记录保存在栈中
在每次拖动时弹出栈顶的 然后放入新的重新绘制
在每次绘制时，先放入一个空的数据类型，然后在绘制的时候弹出顶部放入新的即可


选中绘制边框目前的考虑为，遍历记录栈中的每一个痕迹，比较点击的位置和栈中的位置不超过5px时，算做被选中
被选中的加上一个矩阵边框，图片文字和矩阵等图形较为简单判断，手动绘制的目前考虑为记录上下左右的四个边界值，如果点击在中间即为被选中

### 笔刷颜色bug
在撤销时，进行重绘，并没有对笔刷颜色进行重置，因此绘制出来的图形会是上一次笔刷的颜色

### 获取root上的宏定义的颜色
需要动态更新按钮的颜色，因此需要获取定义在root上的颜色
let root = document.querySelector(":root");
let buttonColor = getComputedStyle(root as Element).getPropertyValue('--button-color');

### 调整笔刷数据类型，加入偏移量
~~由于笔刷样式是基于每一个小段(x, y)绘制的，因此在选中之后进行拖动的话对每一小段进行处理是不合理的
因此加入偏移量，在拖动之后加入一个新的字段，用于标识在(x, y)上偏移的位置~~

最后还是考虑对每一小段进行处理，因为重新绘制是还要计算偏移量，显然是不如直接处理的

### 重构代码 去除过多的else if
在画板的实现过程中，为了区分不同的操作，出现了过多的else if
并且有的部分出现了较高的耦合
test输入的部分，依赖input的change事件，导致不能很好的抽离
考虑将test的绘制分割为两个部分，1，绘制input框，获取需要输入的文字 2，根据文字信息等进行绘制到canvas白板上
1交由canvas组件处理，2为绘制功能
~~其余功能都进行抽离，将代码处理到新增文件中，减少canvas中过多的操作。~~
不必要的不进行抽离，更多的是配置绘制参数，没有必要的抽离则不抽离



### 拖动功能

拖动时计算鼠标起点和终点的(x,y)的差值，对图形进行更改后重绘即可

test类型单机一次为选中，两次为更改，更改时不可拖动

### 网络请求接口封装
不封装了，封装个屁


### 任务安排

~~登录按钮样式~~
~~笔刷按钮样式~~
~~重构笔刷数据类型~~
~~选中功能~~
~~选中之后移动功能~~
~~调整笔刷数据类型，加入偏移量~~
~~处理笔刷颜色bug~~
~~插入文字调整~~
~~插入图片功能调整~~
~~插入图片更改为插入base64值~~
~~图片转换为base64值功能~~
插入文字可选字体，大小等
~~重构代码 去除过多的else if~~
~~插入矩形功能~~
~~插入圆形功能~~
~~网络请求接口封装~~
按钮不可选中时样式更改
优化图片拖动时闪烁的问题
~~整理数据类型~~